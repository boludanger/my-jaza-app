<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jaza Service Requests</title>
    <link rel="icon" type="image/png" href="cropped-Current-Jaza-Logo-1.png">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #C7C9C7;
        }
        .container {
            max-width: 90%;
            margin: auto;
        }
        .jaza-color {
            color: #21CEC9;
        }
        .jaza-border {
            border-color: #21CEC9;
        }
        .jaza-bg {
            background-color: #21CEC9;
        }
        input:focus, select:focus, textarea:focus {
            outline-color: #21CEC9;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <header class="flex items-center justify-between p-4 bg-white shadow-md rounded-lg mb-4">
            <div class="flex items-center space-x-4">
                <img src="cropped-Current-Jaza-Logo-1.png" alt="Jaza Logo" class="h-12">
                <h1 class="text-3xl font-bold jaza-color">Jaza Service Requests</h1>
            </div>
            <div id="tabs" class="flex space-x-2">
                <button id="newRequestTab" class="py-2 px-4 rounded-md font-semibold text-white jaza-bg shadow-sm">New Request</button>
                <button id="dashboardTab" class="py-2 px-4 rounded-md font-semibold text-gray-700 bg-gray-200 shadow-sm">Dashboard</button>
            </div>
        </header>

        <!-- New Request Form -->
        <div id="newRequestView" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold jaza-color mb-4">Submit a New Request</h2>
            <form id="requestForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="requester" class="block text-sm font-medium text-gray-700">Requester <span class="text-red-500">*</span></label>
                        <input type="text" id="requester" placeholder="Enter requester name here" list="requesterList" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                        <datalist id="requesterList"></datalist>
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-700">Department <span class="text-red-500">*</span></label>
                        <input type="text" id="department" placeholder="e.g. Finance, Sales, IT" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700">Position</label>
                        <input type="text" id="position" placeholder="e.g. Analyst, Manager" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="requestDate" class="block text-sm font-medium text-gray-700">Request Date <span class="text-red-500">*</span></label>
                        <input type="date" id="requestDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="requestedDueDate" class="block text-sm font-medium text-gray-700">Requested Due Date <span class="text-red-500">*</span></label>
                        <input type="date" id="requestedDueDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="dataServiceArea" class="block text-sm font-medium text-gray-700">Data/Service Area <span class="text-red-500">*</span></label>
                        <select id="dataServiceArea" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                            <option value="">Select an Area</option>
                            <option value="Data">Data</option>
                            <option value="IT">IT</option>
                        </select>
                    </div>
                    <div>
                        <label for="dataServiceType" class="block text-sm font-medium text-gray-700">Data/Service Type <span class="text-red-500">*</span></label>
                        <select id="dataServiceType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                            <option value="">Select a Type</option>
                            <option value="Data Extract">Data Extract</option>
                            <option value="Report">Report</option>
                            <option value="Dashboard">Dashboard</option>
                        </select>
                    </div>
                    <div>
                        <label for="usedOutsideJaza" class="block text-sm font-medium text-gray-700">Is this information going to be used outside Jaza? <span class="text-red-500">*</span></label>
                        <select id="usedOutsideJaza" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                            <option value="">Select an Option</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div id="organizationNameContainer" style="display:none;">
                        <label for="organizationName" class="block text-sm font-medium text-gray-700">Please specify the name of the organization the information will be shared with</label>
                        <input type="text" id="organizationName" placeholder="e.g. Partner, Client Name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="isRefresh" class="block text-sm font-medium text-gray-700">Is this a refresh of a previous data/service request?</label>
                        <select id="isRefresh" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div id="previousDRContainer" style="display:none;">
                        <label for="previousDR" class="block text-sm font-medium text-gray-700">Previous data/service request number</label>
                        <input type="text" id="previousDR" placeholder="e.g. DR0123" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                </div>
                
                <div class="space-y-4 mt-4">
                    <div>
                        <label for="requestTitle" class="block text-sm font-medium text-gray-700">Request Title <span class="text-red-500">*</span></label>
                        <input type="text" id="requestTitle" placeholder="Give your request a clear and concise title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="requestDetails" class="block text-sm font-medium text-gray-700">Request Details <span class="text-red-500">*</span></label>
                        <textarea id="requestDetails" required rows="4" placeholder="Type the name or details of the request here" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50"></textarea>
                    </div>
                    <div>
                        <label for="requestImage" class="block text-sm font-medium text-gray-700">Image URL for Request Details</label>
                        <input type="url" id="requestImage" placeholder="Paste a public image URL here" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="requestPurpose" class="block text-sm font-medium text-gray-700">Please describe the purpose of this request. What specific question or problem are you trying to address? How will you use this information? <span class="text-red-500">*</span></label>
                        <textarea id="requestPurpose" required rows="4" placeholder="e.g., The goal of this request is to..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50"></textarea>
                    </div>
                    <div>
                        <label for="purposeImage" class="block text-sm font-medium text-gray-700">Image URL for Purpose Description</label>
                        <input type="url" id="purposeImage" placeholder="Paste a public image URL here" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                </div>
                
                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white jaza-bg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Submit Request
                </button>
            </form>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-2xl font-semibold jaza-color mb-4">Service Request Dashboard</h2>
            <div id="requestTableContainer" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DR #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requester</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Request rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="text-center text-gray-500 mt-8 hidden">
                <p>No requests found. Start by submitting a new request!</p>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 class="text-xl font-bold jaza-color mb-4">Request Details</h3>
            <div id="modalContent" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">DR #</p>
                        <p id="modalDRNumber" class="text-lg font-semibold"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Request Title</p>
                        <p id="modalRequestTitle"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Requester</p>
                        <p id="modalRequester"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Request Date</p>
                        <p id="modalRequestDate"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Requested Due Date</p>
                        <input type="date" id="modalRequestedDueDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Data/Service Area</p>
                        <p id="modalDataServiceArea"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Data/Service Type</p>
                        <p id="modalDataServiceType"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Used Outside Jaza?</p>
                        <p id="modalUsedOutsideJaza"></p>
                    </div>
                    <div id="modalOrganizationContainer" style="display:none;">
                        <p class="text-sm font-medium text-gray-500">Organization Name</p>
                        <p id="modalOrganizationName"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Refresh of Previous Request?</p>
                        <p id="modalIsRefresh"></p>
                    </div>
                    <div id="modalPreviousDRContainer" style="display:none;">
                        <p class="text-sm font-medium text-gray-500">Previous DR #</p>
                        <p id="modalPreviousDR"></p>
                    </div>
                    <div id="modalPositionContainer" style="display:none;">
                        <p class="text-sm font-medium text-gray-500">Position</p>
                        <p id="modalPosition"></p>
                    </div>
                    <div id="modalDepartmentContainer" style="display:none;">
                        <p class="text-sm font-medium text-gray-500">Department</p>
                        <p id="modalDepartment"></p>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <p class="text-sm font-medium text-gray-500">Request Details</p>
                        <p id="modalRequestDetails" class="whitespace-pre-wrap"></p>
                        <div id="modalRequestImageContainer"></div>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <p class="text-sm font-medium text-gray-500">Purpose</p>
                        <p id="modalRequestPurpose" class="whitespace-pre-wrap"></p>
                        <div id="modalPurposeImageContainer"></div>
                    </div>
                </div>
                
                <!-- Status Update Section -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h4 class="font-semibold jaza-color mb-2">Update Request</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="modalAssignee" class="block text-sm font-medium text-gray-700">Assignee</label>
                            <input type="text" id="modalAssignee" placeholder="Select an assignee" list="assigneeList" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                            <datalist id="assigneeList"></datalist>
                        </div>
                        <div>
                            <label for="modalPeerReviewer" class="block text-sm font-medium text-gray-700">Peer Reviewer</label>
                            <input type="text" id="modalPeerReviewer" placeholder="Select a peer reviewer" list="peerReviewerList" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                            <datalist id="peerReviewerList"></datalist>
                        </div>
                        <div>
                            <label for="modalStatus" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="modalStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                                <option value="Submitted">Submitted</option>
                                <option value="Assigned">Assigned</option>
                                <option value="Ongoing">Ongoing</option>
                                <option value="In Review">In Review</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Triaged">Triaged</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div id="reviewerBox" style="display:none;">
                            <label for="modalReviewer" class="block text-sm font-medium text-gray-700">Reviewer</label>
                            <input type="text" id="modalReviewer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                        </div>
                        <div class="col-span-1 sm:col-span-2" id="statusCommentContainer" style="display:none;">
                            <label for="statusComment" class="block text-sm font-medium text-gray-700">Status Change Comment</label>
                            <textarea id="statusComment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50"></textarea>
                        </div>
                        <div>
                            <label for="modalAssignedDate" class="block text-sm font-medium text-gray-700">Assigned Date</label>
                            <input type="date" id="modalAssignedDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="modalAgreedDueDate" class="block text-sm font-medium text-gray-700">Agreed Due Date</label>
                            <input type="date" id="modalAgreedDueDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="modalCompleteDate" class="block text-sm font-medium text-gray-700">Complete Date</label>
                            <input type="date" id="modalCompleteDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50">
                        </div>
                        <div class="col-span-1 sm:col-span-2">
                            <label for="modalRequesterComment" class="block text-sm font-medium text-gray-700">Requester/Manager Comment</label>
                            <textarea id="modalRequesterComment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50"></textarea>
                        </div>
                        <div class="col-span-1 sm:col-span-2">
                            <label for="modalAssigneeComment" class="block text-sm font-medium text-gray-700">Assignee Comment</label>
                            <textarea id="modalAssigneeComment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 jaza-border focus:ring focus:ring-opacity-50"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Status History Section -->
                <div id="statusHistorySection" class="bg-gray-50 p-4 rounded-md mt-4">
                    <h4 class="font-semibold jaza-color mb-2">Status History</h4>
                    <ul id="statusHistoryList" class="space-y-2 text-sm">
                        <!-- History items will be inserted here -->
                    </ul>
                </div>
                
                <button id="saveChangesBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white jaza-bg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        let requests = [];
        let currentRequestId = null;
        let nextSerialNumber = 1;

        const staffDirectory = [
            "John Doe", "Jane Smith", "Alex Johnson", "Emily Davis", "Michael Brown",
            "Sarah Wilson", "David Garcia", "Jessica Martinez", "Daniel Rodriguez",
            "Laura Hernandez", "Christopher Lee", "Megan Clark", "James Lewis",
            "Elizabeth Hall", "Charles Allen", "Maria Young", "Matthew King"
        ];

        const populateDatalist = (datalistId, items) => {
            const datalist = document.getElementById(datalistId);
            if (datalist) {
                datalist.innerHTML = '';
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    datalist.appendChild(option);
                });
            }
        };

        const renderRequests = () => {
            const tableBody = document.getElementById('requestTableBody');
            tableBody.innerHTML = '';
            const emptyState = document.getElementById('emptyState');

            if (requests.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            requests.forEach(request => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${request.serialNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.requestTitle || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.requester}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.requestDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.requestStatus || 'Submitted'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.assignee || 'Unassigned'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 view-btn" data-id="${request.id}">View</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        document.getElementById('requestForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const form = e.target;
            const newRequest = {
                id: Date.now(),
                serialNumber: `DR${String(nextSerialNumber++).padStart(4, '0')}`,
                requester: form.requester.value,
                department: form.department.value,
                position: form.position.value,
                requestDate: form.requestDate.value,
                requestedDueDate: form.requestedDueDate.value,
                dataServiceArea: form.dataServiceArea.value,
                dataServiceType: form.dataServiceType.value,
                usedOutsideJaza: form.usedOutsideJaza.value,
                organizationName: form.organizationName.value,
                isRefresh: form.isRefresh.value,
                previousDR: form.previousDR.value,
                requestTitle: form.requestTitle.value,
                requestDetails: form.requestDetails.value,
                requestImage: form.requestImage.value,
                requestPurpose: form.requestPurpose.value,
                purposeImage: form.purposeImage.value,
                requestStatus: 'Submitted',
                statusHistory: [{
                    status: 'Submitted',
                    timestamp: new Date().toISOString(),
                    comment: 'Initial submission'
                }],
            };

            requests.push(newRequest);
            renderRequests();

            alert('Request submitted successfully!');
            form.reset();
            document.getElementById('previousDRContainer').style.display = 'none';
            document.getElementById('organizationNameContainer').style.display = 'none';
        });

        const requestModal = document.getElementById('requestModal');
        const closeModalBtn = document.getElementsByClassName('close')[0];

        document.getElementById('requestTableBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-btn')) {
                const docId = parseInt(e.target.getAttribute('data-id'));
                currentRequestId = docId;

                const data = requests.find(r => r.id === docId);

                if (data) {
                    document.getElementById('modalDRNumber').innerText = data.serialNumber || 'N/A';
                    document.getElementById('modalRequestTitle').innerText = data.requestTitle || 'N/A';
                    document.getElementById('modalRequester').innerText = data.requester || '';
                    document.getElementById('modalRequestDate').innerText = data.requestDate || '';
                    document.getElementById('modalRequestedDueDate').value = data.requestedDueDate || '';
                    document.getElementById('modalDataServiceArea').innerText = data.dataServiceArea || '';
                    document.getElementById('modalDataServiceType').innerText = data.dataServiceType || '';
                    document.getElementById('modalUsedOutsideJaza').innerText = data.usedOutsideJaza || '';
                    document.getElementById('modalOrganizationName').innerText = data.organizationName || '';
                    document.getElementById('modalIsRefresh').innerText = data.isRefresh || '';
                    document.getElementById('modalPreviousDR').innerText = data.previousDR || '';
                    document.getElementById('modalRequestDetails').innerText = data.requestDetails || '';
                    document.getElementById('modalRequestPurpose').innerText = data.requestPurpose || '';
                    
                    document.getElementById('modalAssignee').value = data.assignee || '';
                    document.getElementById('modalPeerReviewer').value = data.peerReviewer || '';
                    document.getElementById('modalStatus').value = data.requestStatus || 'Submitted';

                    document.getElementById('modalAgreedDueDate').value = data.agreedDueDate || '';
                    document.getElementById('modalAssignedDate').value = data.assignedDate || '';
                    document.getElementById('modalCompleteDate').value = data.completeDate || '';
                    document.getElementById('modalRequesterComment').value = data.requesterComment || '';
                    document.getElementById('modalAssigneeComment').value = data.assigneeComment || '';
                    
                    document.getElementById('modalOrganizationContainer').style.display = data.usedOutsideJaza === 'Yes' ? 'block' : 'none';
                    document.getElementById('modalPreviousDRContainer').style.display = data.isRefresh === 'Yes' ? 'block' : 'none';
                    document.getElementById('modalPositionContainer').style.display = data.position ? 'block' : 'none';
                    document.getElementById('modalDepartmentContainer').style.display = data.department ? 'block' : 'none';
                    document.getElementById('modalPosition').innerText = data.position || '';
                    document.getElementById('modalDepartment').innerText = data.department || '';
                    
                    const reqImageContainer = document.getElementById('modalRequestImageContainer');
                    if (data.requestImage) {
                        reqImageContainer.innerHTML = `<img src="${data.requestImage}" class="mt-4 rounded-md" alt="Request Image" />`;
                    } else {
                        reqImageContainer.innerHTML = '';
                    }
                    
                    const purImageContainer = document.getElementById('modalPurposeImageContainer');
                    if (data.purposeImage) {
                        purImageContainer.innerHTML = `<img src="${data.purposeImage}" class="mt-4 rounded-md" alt="Purpose Image" />`;
                    } else {
                        purImageContainer.innerHTML = '';
                    }
                    
                    const historyList = document.getElementById('statusHistoryList');
                    historyList.innerHTML = '';
                    if (data.statusHistory) {
                        data.statusHistory.forEach(entry => {
                            const li = document.createElement('li');
                            const date = new Date(entry.timestamp).toLocaleString();
                            li.innerHTML = `<strong>${date}:</strong> Status changed to <em>${entry.status}</em>. ${entry.comment ? `Comment: ${entry.comment}` : ''}`;
                            historyList.appendChild(li);
                        });
                    }
                    
                    document.getElementById('reviewerBox').style.display = data.requestStatus === 'In Review' ? 'block' : 'none';
                    requestModal.style.display = 'block';

                } else {
                    console.error("No such document!");
                }
            }
        });

        closeModalBtn.onclick = () => {
            requestModal.style.display = 'none';
        };

        window.onclick = (event) => {
            if (event.target == requestModal) {
                requestModal.style.display = 'none';
            }
        };

        document.getElementById('isRefresh').addEventListener('change', (e) => {
            const container = document.getElementById('previousDRContainer');
            if (e.target.value === 'Yes') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        });
        
        document.getElementById('usedOutsideJaza').addEventListener('change', (e) => {
            const container = document.getElementById('organizationNameContainer');
            if (e.target.value === 'Yes') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        });

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('requestDate').setAttribute('min', today);
        document.getElementById('requestedDueDate').setAttribute('min', today);

        document.getElementById('saveChangesBtn').addEventListener('click', () => {
            if (!currentRequestId) return;

            const modalStatus = document.getElementById('modalStatus').value;
            const modalAssignee = document.getElementById('modalAssignee').value;
            const modalPeerReviewer = document.getElementById('modalPeerReviewer').value;
            const statusComment = document.getElementById('statusComment').value;
            const modalReviewer = document.getElementById('modalReviewer').value;
            const modalAssignedDate = document.getElementById('modalAssignedDate').value;
            const modalAgreedDueDate = document.getElementById('modalAgreedDueDate').value;
            const modalCompleteDate = document.getElementById('modalCompleteDate').value;
            const modalRequesterComment = document.getElementById('modalRequesterComment').value;
            const modalAssigneeComment = document.getElementById('modalAssigneeComment').value;

            
            const requestIndex = requests.findIndex(r => r.id === currentRequestId);
            if (requestIndex === -1) return;

            const data = requests[requestIndex];

            data.assignee = modalAssignee;
            data.peerReviewer = modalPeerReviewer;
            data.reviewer = modalReviewer;
            data.assignedDate = modalAssignedDate;
            data.agreedDueDate = modalAgreedDueDate;
            data.completeDate = modalCompleteDate;
            data.requesterComment = modalRequesterComment;
            data.assigneeComment = modalAssigneeComment;

            if (modalStatus !== data.requestStatus) {
                const newStatusEntry = {
                    status: modalStatus,
                    timestamp: new Date().toISOString(),
                    comment: statusComment
                };
                data.requestStatus = modalStatus;
                data.statusHistory.push(newStatusEntry);
            }

            // Simulating email notifications
            if (modalAssignee && modalAssignee !== (data.assignee || '')) {
                console.log(`Email sent to new assignee: ${modalAssignee} for request: ${data.serialNumber}`);
            }
            if (modalPeerReviewer && modalPeerReviewer !== (data.peerReviewer || '')) {
                console.log(`Email sent to new peer reviewer: ${modalPeerReviewer} for request: ${data.serialNumber}`);
            }

            renderRequests();
            alert('Changes saved successfully!');
            requestModal.style.display = 'none';
        });

        document.getElementById('modalStatus').addEventListener('change', (e) => {
            const statusCommentContainer = document.getElementById('statusCommentContainer');
            const reviewerBox = document.getElementById('reviewerBox');
            if (e.target.value !== 'Submitted') {
                statusCommentContainer.style.display = 'block';
            } else {
                statusCommentContainer.style.display = 'none';
            }
            if (e.target.value === 'In Review') {
                reviewerBox.style.display = 'block';
            } else {
                reviewerBox.style.display = 'none';
            }
        });

        const newRequestTab = document.getElementById('newRequestTab');
        const dashboardTab = document.getElementById('dashboardTab');
        const newRequestView = document.getElementById('newRequestView');
        const dashboardView = document.getElementById('dashboardView');

        newRequestTab.addEventListener('click', () => {
            newRequestView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            newRequestTab.classList.add('jaza-bg', 'text-white');
            newRequestTab.classList.remove('bg-gray-200', 'text-gray-700');
            dashboardTab.classList.add('bg-gray-200', 'text-gray-700');
            dashboardTab.classList.remove('jaza-bg', 'text-white');
        });

        dashboardTab.addEventListener('click', () => {
            dashboardView.classList.remove('hidden');
            newRequestView.classList.add('hidden');
            dashboardTab.classList.add('jaza-bg', 'text-white');
            dashboardTab.classList.remove('bg-gray-200', 'text-gray-700');
            newRequestTab.classList.add('bg-gray-200', 'text-gray-700');
            newRequestTab.classList.remove('jaza-bg', 'text-white');
        });

        window.onload = () => {
            populateDatalist('requesterList', staffDirectory);
            populateDatalist('assigneeList', staffDirectory);
            populateDatalist('peerReviewerList', staffDirectory);
            renderRequests();
        };
    </script>
</body>
</html>
